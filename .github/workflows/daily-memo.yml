name: Auto Daily Memo Generator

on:
  schedule:
    # æ¯å¤© 12:00 UTC (20:00 GMT+8)
    - cron: '0 12 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  generate-memo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Create content directory
        run: |
          mkdir -p content

      - name: Get GitHub Trending
        id: github
        run: |
          # è·å– GitHub Trending AI é¡¹ç›®
          GITHUB_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/repositories?q=AI+OR+artificial+intelligence+OR+machine+learning+OR+deep+learning+OR+llm+OR+chatgpt&sort=stars&order=desc&per_page=10")

          echo "$GITHUB_DATA" > github_data.json

      - name: Get Product Hunt Posts
        id: producthunt
        env:
          PH_API_KEY: ${{ secrets.PRODUCTHUNT_API_KEY }}
        run: |
          # è·å– Product Hunt AI äº§å“
          PH_DATA=$(curl -s -X POST \
            -H "Authorization: Bearer $PH_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { posts(order: RANKING, first: 30) { edges { node { id name description url votesCount createdAt featuredAt thumbnail { url } topics { edges { node { name } } } } } } }"
            }' \
            "https://api.producthunt.com/v2/api/graphql")

          echo "$PH_DATA" > producthunt_data.json

      - name: Generate Daily Memo
        id: memo
        run: |
          TODAY=$(date +%Y-%m-%d)
          
          # è·å–ç°æœ‰ Memo æ•°é‡
          MEMO_NUM=$(ls -1 content/*.md 2>/dev/null | wc -l | tr -d ' ')
          if [ "$MEMO_NUM" -eq 0 ]; then
            MEMO_NUM=1
          else
            MEMO_NUM=$((MEMO_NUM + 1))
          fi
          
          # ç”Ÿæˆ Memo æ–‡ä»¶
          cat > "content/${TODAY}.md" << 'EOF'
          ---
          date: $TODAY
          title: AI åˆ›ä¸šåœˆè§‚å¯Ÿ - ç¬¬${MEMO_NUM}æœŸ
          techInsights:
            - GitHub Trending AI é¡¹ç›®
            - Product Hunt æ–°å“å‘å¸ƒ
          trendingProjects:
            - è‡ªåŠ¨åˆ†æ
          edTechInnovation:
            - AI åˆ›ä¸šæ–¹å‘æ´å¯Ÿ
          ---

          # ğŸ¤– AI åˆ›ä¸šåœˆè§‚å¯Ÿ - ç¬¬${MEMO_NUM}æœŸ

          > è‡ªåŠ¨ç”Ÿæˆäº $TODAY | æ•°æ®æ¥æº: GitHub Trending + Product Hunt

          ---

          ## ğŸ¤– æŠ€æœ¯è§‚å¯Ÿ

          ### ğŸ”¥ ä»Šæ—¥ AI çªç ´ï¼ˆGitHub Trendingï¼‰

          æ³¨æ„ï¼šæ­¤ Memo ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œæ•°æ®å¯èƒ½éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚
          è¯·æ‰‹åŠ¨å®¡æŸ¥å’Œè¡¥å……å†…å®¹ã€‚
          EOF

          echo "Generated: content/${TODAY}.md"

      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add content/*.md
            git commit -m "Auto: Generate daily memo for $(date +%Y-%m-%d)"
            git push
          fi
